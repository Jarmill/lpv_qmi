%try to synthesize a stabilizing controller

load('data_test.mat')
rng(30, 'twister');

%set up properties
n = size(Xp, 1);
[m, T] = size(U);

Psi = sample_matrix([Xn, Xp(:, end)], U, epsilon);

%declare variables
alpha = sdpvar(1,1);
beta = sdpvar(1,1);

P = sdpvar(n, n);
L = sdpvar(m, n);
delta = 1e-6;

CTRL_TOP = P - beta*eye(n);
CTRL_BOT = [-P, -L', zeros(n, n);
            -L, zeros(m, m), L;
            zeros(n, n), L', P];
CTRL = blkdiag(CTRL_TOP, CTRL_BOT);

DATA = blkdiag(Psi, zeros(n,n));


cons = [beta>=delta;
        P >= delta*eye(n);
        CTRL - alpha*DATA >= 0;        